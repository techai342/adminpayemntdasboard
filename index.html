<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Admin - Slot Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #000; min-height: 100vh; color: #e2e8f0; }
        .bg-fixed {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://ik.imagekit.io/shaban/SHABAN-1768843573796_wWUQgJ0Uo.jpg');
            background-size: cover; opacity: 0.8; z-index: -1;
        }
        .glass {
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .active-tab { border-bottom: 3px solid #f97316; color: #f97316; }
        
        .slot-bar { height: 8px; width: 100%; border-radius: 4px; margin-top: 6px; }
        .status-free { background: #22c55e; box-shadow: 0 0 10px #22c55e66; }
        .status-sent { background: #eab308; box-shadow: 0 0 10px #eab30866; }
        .status-filled { background: #ef4444; box-shadow: 0 0 10px #ef444466; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #0f172a; }

        .btn-manager {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            box-shadow: 0 4px 15px rgba(234, 88, 12, 0.3);
            transition: all 0.3s ease;
        }
        .btn-manager:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(234, 88, 12, 0.5);
        }
    </style>
</head>
<body class="font-sans">
    <div class="bg-fixed"></div>

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8 glass p-6 rounded-3xl shadow-2xl">
            <div class="flex items-center gap-4">
                <div>
                    <h1 class="text-2xl font-black text-white italic uppercase tracking-wider">Payment Admin</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        <p class="text-[10px] text-slate-400 font-bold tracking-[0.2em] uppercase">System Online</p>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <a href="https://admindta.vercel.app/" target="_blank" class="btn-manager px-6 py-3 rounded-xl text-white font-black text-xs uppercase tracking-widest flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    Squad Manager
                </a>
                <button onclick="location.reload()" class="bg-white/5 hover:bg-white/10 p-3 rounded-xl transition border border-white/10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                </button>
            </div>
        </header>

        <!-- Tabs -->
        <div class="flex gap-8 border-b border-white/10 mb-8 overflow-x-auto pb-1">
            <button onclick="switchTab('new')" id="tab-new" class="pb-4 font-black uppercase text-xs active-tab whitespace-nowrap transition-all">New Requests</button>
            <button onclick="switchTab('old')" id="tab-old" class="pb-4 font-black uppercase text-xs text-slate-500 whitespace-nowrap transition-all">History & Reset</button>
            <button onclick="switchTab('slots')" id="tab-slots" class="pb-4 font-black uppercase text-xs text-slate-500 whitespace-nowrap transition-all">Slot Visualizer</button>
        </div>

        <!-- NEW REQUESTS -->
        <div id="section-new" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <!-- HISTORY & RESET -->
        <div id="section-old" class="hidden space-y-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center glass p-6 rounded-3xl gap-4 border border-red-500/20">
                <div>
                    <h3 class="text-white font-black uppercase italic tracking-wider">Danger Zone: Full Tournament Reset</h3>
                    <p class="text-[10px] text-slate-500 font-bold uppercase mt-1">‚ö†Ô∏è This will delete ALL registrations and unassign ALL slots.</p>
                </div>
                <button onclick="resetAllSlots()" class="bg-red-600 hover:bg-red-500 text-white px-8 py-3 rounded-xl font-black text-xs uppercase tracking-widest transition-all shadow-lg shadow-red-900/40">
                    üî• Full Reset (All Slots)
                </button>
            </div>

            <div class="glass rounded-3xl overflow-hidden border border-white/10">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-black/40 text-[10px] font-black uppercase text-slate-400 tracking-wider">
                            <tr>
                                <th class="p-5">User Name</th>
                                <th class="p-5">TRX ID</th>
                                <th class="p-5">Assigned Slot</th>
                                <th class="p-5">Squad Status</th>
                                <th class="p-5">Controls</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody" class="divide-y divide-white/5 text-sm font-bold"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SLOT VISUALIZER -->
        <div id="section-slots" class="hidden">
            <div class="flex flex-wrap gap-4 mb-8 glass p-4 rounded-2xl inline-flex">
                <div class="flex items-center gap-2"><div class="w-3 h-3 bg-green-500 rounded shadow-[0_0_10px_#22c55e]"></div> <span class="text-[10px] font-black uppercase">Green: Free</span></div>
                <div class="flex items-center gap-2"><div class="w-3 h-3 bg-yellow-500 rounded shadow-[0_0_10px_#eab308]"></div> <span class="text-[10px] font-black uppercase">Yellow: Sent (Pending)</span></div>
                <div class="flex items-center gap-2"><div class="w-3 h-3 bg-red-500 rounded shadow-[0_0_10px_#ef4444]"></div> <span class="text-[10px] font-black uppercase">Red: Filled</span></div>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4" id="slotsGrid"></div>
        </div>
    </div>

    <!-- VERIFY MODAL -->
    <div id="verifyModal" class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-slate-900 border border-white/10 rounded-[2.5rem] w-full max-w-5xl p-6 md:p-8 flex flex-col md:flex-row gap-8 overflow-y-auto max-h-[95vh] shadow-2xl">
            <div class="flex-1 bg-black rounded-3xl overflow-hidden border border-white/5 relative group">
                <img id="modalImg" class="w-full h-full object-contain" src="">
                <a id="modalImgLink" href="#" target="_blank" class="absolute inset-0 flex items-center justify-center bg-black/50 opacity-0 group-hover:opacity-100 transition-all text-white font-bold uppercase text-xs">View Full Size</a>
            </div>
            
            <div class="flex-1 flex flex-col justify-center">
                <h2 class="text-3xl font-black text-white italic uppercase mb-2">Review Payment</h2>
                <p class="text-slate-500 text-xs font-bold uppercase mb-8 border-b border-white/10 pb-4">Verify details before assigning slot</p>
                
                <div class="space-y-4 mb-8">
                    <div class="flex justify-between items-center bg-white/5 p-4 rounded-xl">
                        <span class="text-xs text-slate-400 font-black uppercase">Sender Name</span>
                        <span class="font-bold text-white text-lg" id="modalName">---</span>
                    </div>
                    <div class="flex justify-between items-center bg-white/5 p-4 rounded-xl">
                        <span class="text-xs text-slate-400 font-black uppercase">Method</span>
                        <span class="font-bold text-orange-400" id="modalMethod">---</span>
                    </div>
                    <div class="flex justify-between items-center bg-white/5 p-4 rounded-xl border border-orange-500/20">
                        <span class="text-xs text-slate-400 font-black uppercase">TRX ID</span>
                        <span class="font-mono font-black text-xl text-orange-500" id="modalTrx">---</span>
                    </div>
                </div>

                <div class="mb-8">
                    <label class="block text-xs font-black text-green-500 uppercase mb-2 tracking-widest">Select Slot to Assign</label>
                    <div class="relative">
                        <select id="slotSelect" class="w-full bg-slate-800 p-4 rounded-xl border border-slate-600 text-white font-bold text-sm focus:border-green-500 outline-none appearance-none">
                            <option value="">Loading Slots...</option>
                        </select>
                        <div class="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-slate-400">‚ñº</div>
                    </div>
                </div>

                <div class="flex flex-col gap-3 mt-auto">
                    <button onclick="approveAction()" class="w-full bg-green-600 hover:bg-green-500 py-4 rounded-2xl font-black uppercase text-sm tracking-widest shadow-lg shadow-green-900/30 transition-all">Confirm & Send Slot</button>
                    <div class="flex gap-3">
                        <button onclick="rejectAction()" class="flex-1 bg-red-500/10 hover:bg-red-600 text-red-500 hover:text-white py-3 rounded-2xl font-black uppercase text-xs transition-all border border-red-500/20">Reject Request</button>
                        <button onclick="closeModal()" class="flex-1 bg-white/5 hover:bg-white/10 text-slate-300 py-3 rounded-2xl font-black uppercase text-xs transition-all">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = "https://psiypllbqopudppugaxe.supabase.co"; 
        const SB_KEY = "sb_publishable_PsL-7tSFu4EQU5ZHQgO6UA_Segl7g_e";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        let selectedUser = null;

        function switchTab(tab) {
            ['new', 'old', 'slots'].forEach(t => {
                document.getElementById(`section-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).className = "pb-4 font-black uppercase text-xs text-slate-500 whitespace-nowrap transition-all";
            });
            document.getElementById(`section-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).className = "pb-4 font-black uppercase text-xs active-tab whitespace-nowrap transition-all";

            if(tab === 'new') loadNew();
            if(tab === 'old') loadHistory();
            if(tab === 'slots') loadSlotsGrid();
        }

        async function fetchSlotStatuses() {
            const { data: auths } = await supabaseClient.from('squad_auth').select('user_id').order('user_id');
            const { data: assigned } = await supabaseClient.from('payment_users').select('assigned_auth_id').eq('status', 'approved');
            const { data: filled } = await supabaseClient.from('squad_registrations').select('auth_user_id');

            const assignedIds = assigned ? assigned.map(a => a.assigned_auth_id) : [];
            const filledIds = filled ? filled.map(f => f.auth_user_id) : [];

            return auths.map(slot => {
                let status = 'green';
                if (assignedIds.includes(slot.user_id)) status = 'yellow';
                if (filledIds.includes(slot.user_id)) status = 'red';
                return { id: slot.user_id, status: status };
            });
        }

        async function loadNew() {
            const container = document.getElementById('section-new');
            container.innerHTML = '<div class="col-span-full py-20 text-center animate-pulse font-bold text-slate-500">Scanning for requests...</div>';
            
            const { data } = await supabaseClient.from('payment_users')
                .select('*')
                .eq('status', 'pending')
                .not('trx_id', 'is', null)
                .order('created_at', {ascending: false});

            if(!data || data.length === 0) {
                container.innerHTML = '<div class="col-span-full py-20 text-center text-slate-600 font-black uppercase tracking-widest border border-white/5 rounded-3xl">No Pending Approvals</div>';
                return;
            }

            container.innerHTML = '';
            data.forEach(u => {
                container.innerHTML += `
                    <div class="glass p-6 rounded-[2rem] border-l-4 border-orange-500 hover:bg-white/5 transition group">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="font-black text-lg text-white uppercase truncate">${u.full_name}</h3>
                            <span class="text-[9px] bg-orange-500/20 text-orange-400 px-2 py-1 rounded font-bold">NEW</span>
                        </div>
                        <div class="space-y-3 mb-6 bg-black/20 p-4 rounded-xl">
                            <p class="text-xs text-slate-400 flex justify-between"><span>Method:</span> <span class="text-white font-bold">${u.payment_method}</span></p>
                            <p class="text-xs text-slate-400 flex justify-between"><span>TRX ID:</span> <span class="text-orange-500 font-mono font-bold">${u.trx_id}</span></p>
                        </div>
                        <button onclick='openVerify(${JSON.stringify(u)})' class="w-full bg-white/10 group-hover:bg-orange-600 hover:text-white py-3 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all">Open Verification</button>
                    </div>
                `;
            });
        }

        async function loadHistory() {
            const body = document.getElementById('historyBody');
            body.innerHTML = '<tr><td colspan="5" class="p-10 text-center">Loading...</td></tr>';
            
            const { data: users } = await supabaseClient.from('payment_users').select('*').neq('status', 'pending').order('created_at', {ascending: false});
            const slots = await fetchSlotStatuses();
            const filledMap = {};
            slots.forEach(s => filledMap[s.id] = s.status);

            body.innerHTML = '';
            users.forEach(u => {
                const isApproved = u.status === 'approved';
                const assignedId = u.assigned_auth_id;
                
                let rowStatusHtml = `<span class="text-red-500">REJECTED</span>`;
                let controlButtons = '';
                
                if(isApproved && assignedId) {
                    const status = filledMap[assignedId];
                    if(status === 'red') {
                        rowStatusHtml = `<span class="bg-red-500/20 text-red-400 px-2 py-1 rounded text-[10px]">üî¥ FILLED</span>`;
                    } else {
                        rowStatusHtml = `<span class="bg-yellow-500/20 text-yellow-400 px-2 py-1 rounded text-[10px]">üü° SENT</span>`;
                    }
                    // Reset Button for Single User
                    controlButtons += `<button onclick="resetIndividualBooking('${u.id}', '${assignedId}')" class="bg-orange-600/20 text-orange-400 px-3 py-1 rounded-lg text-[10px] uppercase hover:bg-orange-600 hover:text-white transition-all mr-2">Reset Booking</button>`;
                }

                body.innerHTML += `
                    <tr class="hover:bg-white/5 transition border-b border-white/5">
                        <td class="p-5 font-bold text-white">${u.full_name}</td>
                        <td class="p-5 font-mono text-xs text-slate-400">${u.trx_id || '-'}</td>
                        <td class="p-5 font-black text-orange-500">${assignedId || '-'}</td>
                        <td class="p-5 font-black uppercase text-[10px]">${rowStatusHtml}</td>
                        <td class="p-5 flex items-center gap-2">
                            ${controlButtons}
                            <button onclick="deletePaymentUser(${u.id})" class="text-xs text-slate-500 underline hover:text-red-500">Delete Record</button>
                        </td>
                    </tr>
                `;
            });
        }

        // --- RESET LOGIC ---

        async function resetIndividualBooking(userId, authId) {
            if(!confirm(`‚ö†Ô∏è Reset Booking for this user?\n\nThis will:\n1. Delete squad data (if any)\n2. Reset user status to 'new'\n3. Make slot ${authId} free again.`)) return;
            
            try {
                // Delete squad registration
                await supabaseClient.from('squad_registrations').delete().eq('auth_user_id', authId);
                
                // Reset user record
                const { error } = await supabaseClient.from('payment_users').update({
                    status: 'new',
                    assigned_auth_id: null,
                    trx_id: null,
                    screenshot_url: null,
                    payment_method: null
                }).eq('id', userId);

                if(!error) {
                    alert("User Booking Reset Successful!");
                    loadHistory();
                    loadSlotsGrid();
                }
            } catch (err) { alert("Error resetting user: " + err.message); }
        }

        async function resetAllSlots() {
            const pin = prompt("üö® DANGER ZONE\nTo delete ALL data and reset ALL slots, type 'CONFIRM':");
            if (pin !== 'CONFIRM') return;

            try {
                // 1. Delete ALL registrations
                await supabaseClient.from('squad_registrations').delete().neq('id', 0);

                // 2. Reset ALL payment users to new
                const { error } = await supabaseClient.from('payment_users').update({
                    status: 'new',
                    assigned_auth_id: null,
                    trx_id: null,
                    screenshot_url: null,
                    payment_method: null,
                    account_name: null
                }).neq('id', 0);

                if (!error) {
                    alert("‚úÖ System Fresh: All Slots Reset!");
                    location.reload();
                } else { throw error; }
            } catch (error) { alert("Reset failed: " + error.message); }
        }

        // --- GRID LOGIC ---

        async function loadSlotsGrid() {
            const grid = document.getElementById('slotsGrid');
            grid.innerHTML = '<div class="col-span-full text-center">Analysing Slots...</div>';
            const slots = await fetchSlotStatuses();
            
            grid.innerHTML = '';
            slots.forEach(s => {
                let colorClass = 'status-free';
                let label = 'Free';
                if (s.status === 'yellow') { colorClass = 'status-sent'; label = 'Sent'; }
                if (s.status === 'red') { colorClass = 'status-filled'; label = 'Filled'; }

                let actionBtn = '';
                if(s.status === 'red' || s.status === 'yellow') {
                    actionBtn = `<button onclick="resetSquadDataOnly('${s.id}')" class="mt-2 text-[8px] bg-red-500/20 text-red-400 px-2 py-1 rounded uppercase hover:bg-red-500 hover:text-white w-full transition">Clear Squad Data</button>`;
                }

                grid.innerHTML += `
                    <div class="glass p-4 rounded-2xl text-center hover:bg-white/5 transition">
                        <p class="text-xs font-black text-white mb-2">${s.id}</p>
                        <div class="slot-bar ${colorClass}"></div>
                        <p class="text-[9px] font-bold uppercase mt-2 opacity-60">${label}</p>
                        ${actionBtn}
                    </div>
                `;
            });
        }

        // Helpers
        async function openVerify(user) {
            selectedUser = user;
            document.getElementById('modalImg').src = user.screenshot_url;
            document.getElementById('modalImgLink').href = user.screenshot_url;
            document.getElementById('modalName').innerText = user.full_name;
            document.getElementById('modalMethod').innerText = user.payment_method;
            document.getElementById('modalTrx').innerText = user.trx_id;
            
            const sel = document.getElementById('slotSelect');
            sel.innerHTML = '<option value="">Checking slots...</option>';
            const slots = await fetchSlotStatuses();
            sel.innerHTML = '<option value="">Select a Slot...</option>';
            
            slots.forEach(s => {
                let emoji = 'üü¢'; let text = 'FREE';
                if(s.status === 'yellow') { emoji = 'üü°'; text = 'SENT'; }
                if(s.status === 'red') { emoji = 'üî¥'; text = 'FILLED'; }
                sel.innerHTML += `<option value="${s.id}">${emoji} ${s.id} [${text}]</option>`;
            });
            document.getElementById('verifyModal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('verifyModal').classList.add('hidden'); }

        async function approveAction() {
            const slot = document.getElementById('slotSelect').value;
            if(!slot) return alert("Select a slot first!");
            const { error } = await supabaseClient.from('payment_users').update({
                status: 'approved', assigned_auth_id: slot
            }).eq('id', selectedUser.id);
            if(!error) { closeModal(); loadNew(); }
        }

        async function rejectAction() {
            if(!confirm("Reject payment?")) return;
            const { error } = await supabaseClient.from('payment_users').update({ status: 'rejected' }).eq('id', selectedUser.id);
            if(!error) { closeModal(); loadNew(); }
        }

        async function resetSquadDataOnly(authId) {
            if(!confirm(`Delete registration data for ${authId}?`)) return;
            await supabaseClient.from('squad_registrations').delete().eq('auth_user_id', authId);
            loadHistory(); loadSlotsGrid();
        }
        
        async function deletePaymentUser(id) {
             if(!confirm("Permanently delete this user record from database?")) return;
             await supabaseClient.from('payment_users').delete().eq('id', id);
             loadHistory();
        }

        loadNew();
    </script>
</body>
</html>
